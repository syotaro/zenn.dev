---
title: "テストの自動化設計（by Cypress）"
emoji: "👏"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [cypress,test,]
published: false
---


- [まとめ](#まとめ)
    - [未整理情報](#未整理情報)

---

https://www.youtube.com/watch?v=LcGHiFnBh3Y

![Cypress](https://www.cypress.io/)

## Cypress概要
<!--https://qiita.com/eyuta/items/a2454719c2d82c8bacd5#13-%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB -->

- [公式Github（cypress-io/cypress）](https://github.com/cypress-io/cypress)
- [公式ドキュメント（Why? Cypress）](https://docs.cypress.io/guides/overview/why-cypress)

Cypressはフロントエンドのテストツール。以下のすべてを作成・テストできる。

- エンドツーエンド（E2E）テスト
- 統合（インテグレーション）テスト
- 単体テスト

## Cypressのエコシステム（Cypress ecosystem）

- Cypressはローカルにインストールされるテストランナーと、テスト記録用のダッシュボードで構成される。

- 開発中: ローカルでアプリケーションを開発中、常にテストを回すことができる（=TDD に最適！）
- 開発後: テストを構築し、CypressをCIツールと統合した後、ダッシュボードでテストの実行結果を記録・確認できる
1.2. 特徴（Features）
タイムトラベル:
Cypress はテスト実行時にスナップショットを取得できる
コマンドログにカーソルを合わせると、各ステップの詳細を確認できる
デバッグ可能:
テストの失敗理由を推測せず、開発ツールから直接デバッグできる
そのため、読み込み可能なエラーとスタックトレースにより、デバッグが非常に高速になる
自動待機:
テストに await や sleep はいらない
Cypress は、コマンドやアサーション時に要素が見つからない場合、自動で再試行する
Stubs, Spies, Clocks:
sinonの Spy や Stub をラップしている
Clocks（Date、setTimeout、clearTimeout、setInterval, clearInterval）のラッパーも提供している
ネットワークトラフィック制御
サーバーを使用せずに、ネットワークリクエストを制御、Stub, テストできる
一貫した結果
Selenium や WebDriver を使用していないため、高速で一貫性のある信頼性の高いテストを提供する
スクリーンショットとビデオ
失敗時に、以下を表示できる
自動的に撮影されたスクリーンショット
CLI から実行した場合のテストスイート全体のビデオ
クロスブラウザテスト
CI パイプライン上で、Firefox および Chrome 系のブラウザを用いて最適なテストを実行できる
1.3. サンプル
公式動画: Cypress をインストールしてから実際にテストケースを蹴るところまで、簡潔にまとまっている
cypress-io/cypress-realworld-app: Cypress のテスト手法やシナリオを実践するためのアプリケーション

1.4. テストタイプ
E2E テスト
一般的な E2E テストのように、ブラウザでアプリケーションにアクセスし、実際のユーザーと同じように UI を介してアクションを実行する。

it（"adds todos", （） => {
cy.visit（"https://todo.app.com"）;
cy.get（".new-input"）.type（"write code{enter}"）.type（"write tests{enter}"）;
// confirm the application is showing two items
cy.get（"li.todo"）.should（"have.length", 2）;
}）;
コンポーネントテスト
一部の Web フレームワーク （Rect or Vue） からコンポーネントをマウントすることで、コンポーネントテストも実行できる。
jest や mocha のようにコンポーネントを jsdom でレンダリングするのではなく、実際のブラウザ上にコンポーネントをマウントし、そのコンポーネントに対してテストを行う。

※ただし、現状（2021/06/19）段階でアルファ版なので注意

import { mount } from "@cypress/react"; // or @cypress/vue
import TodoList from "./components/TodoList";

it（"contains the correct number of todos", （） => {
const todos = [
{ text: "Buy milk", id: 1 },
{ text: "Learn Component Testing", id: 2 },
];

mount（<TodoList todos={todos} />）;
// the component starts running like a mini web app
cy.get（"[data-testid=todos]"）.should（"have.length", todos.length）;
}）;
API テスト
Cypress は任意の HTTP 呼び出しを実行できるため、API テストも可能。

it（"adds a todo", （） => {
cy.request（{
url: "/todos",
method: "POST",
body: {
title: "Write REST API",
},
}）
.its（"body"）
.should（"deep.contain", {
title: "Write REST API",
completed: false,
}）;
}）;
その他
多数のプラグインを活用することで、a11y、画像回帰、電子メールテスト等々が可能。

ここ2ヶ月ほどE2EテストフレームワークのCypressに入門しているので、概要や所感を簡単にまとめてみます。

E2Eテストとはなにか？
E2Eはend-to-endの略で、直訳すると「端から端まで」という意味になります。E2Eテストとは、他のテスト手法である単体テストといったコードベースのテストとは違い、実際にユーザーが体験する動作をベースにテストコードが書ける技術です。具体的にいうとCypressでは、テストコードを実行するとブラウザが立ち上がり、ブラウザ内で指定した挙動（ページを開く、要素をクリックする）のほとんどを行うことができ、またその結果として表示された文字列や遷移先のページなどをアサートできます。

PHPにおけるPHPUnitや、RubyにおけるRspec、JavaScriptにおけるJest等は、それぞれその言語で実装されたコード内でのテストに（基本的には）とどまったテストを行えますが、Cypressはアプリケーションがどんな言語やフレームワークで実装されたWebアプリケーションかは（基本的には）依存しません。つまり、言語やフレームワークがリプレイスしたり破壊的変更を伴ったとしても生き続けることができます。

Cypress以外にどんなツールがあるか
ザッと調べた範疇では、Playwrightがライバルだと感じました。

playwrightの長所として大きいなと感じたのは複数のページ（タブ）を単一のテストケースでサポートできることです。

複数タブについてはCypressはアーキテクチャ上、永久にサポート不可能とのことで、aタグにblankが設定されることをアサートしてね、と書いています。

また、CypressよりPlaywrightのほうが、Microsoft製なのでTypeScriptがout-of-the-boxで対応できるのも少々便利に思います。

逆にCypressで期待できる点はComponent Testingというコンポーネント単位でE2Eできるという衝撃的な新機能です。

これまでページ単位でしかテストできないのがE2Eの常識だったと思うのですが、コンポーネント単位のE2Eという発想は、日々の開発スタイルをよりTDDに寄せやすくなるのですごい発想だなと感じています。

また、Cypressはベストプラクティスをドキュメントとして公開しており、これはドキュメントの冒頭にも「我々はドキュメントに”何”より”なぜ”を書きます」といった旨のことが書いてあるので有言実行で魅力的に思いました。

Cypressで実際に書いてみたこと
試しに実運用中のアプリケーションに対してCypressでいくつかテストケースを書いてみたので、そのときに工夫したことを書いてみます。

本格的に書いてみるときは必ず以下のドキュメントを一読することがおすすめです。本記事では印象的なところだけ切り出して説明します。

## まとめ

- 実運用上の課題
- ステージング環境で、POSTを伴ったりテストカードで決済するE2Eを毎日回すと、どんどんゴミデータが増える。どう対策するか？
- ローカルでTDDするためにはずっとCypressを起動したままにしたいが、Chromeを立ち上げているせいかしばらくするとPCが重くなる気がする
- できれば個々のテストは互いの実行順に依存しないようにしたいが、特定の条件がそろったユーザーによるテストなどはその条件をそろえるテストを前段に入れたくなり、長くなる。バックエンドのテストと違ってシーダーを直で実行できない。/db:seedといったエンドポイントをステージング環境以前を前提にして用意すべきなのか？
もしよかったら一緒にカジュアル面談の体で相談したり語り合っていただける方を緩募しています！よろしくお願いします〜。Playwrightとの優位性も気になる！

## 未整理情報

https://shiki-lab.slack.com/archives/C038B99K9C4/p1649896765960959
